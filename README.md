# 分布式系统架构文档

## 系统概述

本项目是一个基于三层分布式架构的高性能网关系统，采用微服务架构设计，各服务之间通过gRPC进行通信，为客户端提供统一的接入入口和负载均衡服务。

## 架构设计

### 整体架构图

text

```
客户端层
    │
    │ HTTP/HTTPS
    ▼
┌─────────────────┐
│   路由网关服务   │ ←── 第一层：统一接入层
│   (Gateway)     │
└─────────────────┘
    │  ┌────────────────────────────┐
    │  │ 认证请求 │ 服务发现请求      │
    │  └────────────────────────────┘
    │ gRPC                          │ gRPC
    ▼                               ▼
┌─────────────────┐             ┌─────────────────┐
│   验证服务       │             │   调度服务       │ ←── 第二层：业务服务层
│   (Verify)      │             │  (Scheduler)    │
└─────────────────┘             └─────────────────┘
                                       │
                                       │ 集群状态同步
                                       ▼
┌─────────────────────────────────────────────────┐
│             消息集群层 (Message Cluster)         │ ←── 第三层：数据处理层
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │  集群节点1   │  │  集群节点2   │  │  集群节点N   │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────┘
```



## 服务职责说明

### 第一层：路由网关服务 (Gateway)

- **定位**: 系统入口，统一接入层
- **职责**:
  - 接收所有客户端HTTP/HTTPS请求
  - 请求认证转发（调用验证服务）
  - 服务发现请求（调用调度服务）
  - 响应客户端服务地址信息
- **通信方式**: HTTP/HTTPS（对外），gRPC（对内）

### 第二层：业务服务层

#### 验证服务 (Verify Service)

- **定位**: 身份认证中心
- **职责**:注册验证
- **通信方式**: gRPC

#### 调度服务 (Scheduler Service)

- **定位**: 负载均衡与服务发现中心
- **职责**:
  - 监控消息集群节点状态
  - 负载均衡决策
  - 服务地址分配
  - 集群健康检查
- **通信方式**: gRPC

### 第三层：消息集群服务 (Message Cluster)

- **定位**: 业务处理核心层
- **职责**:
  - 处理客户端TCP长连接
  - 业务逻辑执行
  - 消息路由与转发
  - 数据持久化
- **通信方式**: TCP长连接（对外），gRPC（对内）

## 数据流说明

### 1. 客户端接入流程

text

```
客户端 → 网关服务 → 验证服务 → 调度服务 → 客户端 → 消息集群
    ↓        ↓         ↓         ↓         ↓        ↓
   HTTP    认证请求   认证结果   集群地址   TCP连接  业务处理
```

### 2. 服务发现流程

1. 客户端向网关发送服务请求
2. 网关调用验证服务进行身份认证
3. 网关调用调度服务获取最优消息集群地址
4. 网关将集群地址返回给客户端
5. 客户端直接与消息集群建立TCP长连接

### 3. 集群管理流程

- 调度服务定期收集各消息集群节点的负载信息
- 根据负载情况动态调整服务分配策略
- 支持集群节点的动态扩缩容

## 容错与高可用

### 故障恢复机制

- **服务层**: 服务集群，服务发现，故障转移
- **调度层**：心跳响应，断线重连
- **集群层**: 节点冗余，数据备份，自动故障恢复

### 数据一致性

- 通过gRPC保证服务间通信的可靠性
- 关键业务数据采用最终一致性方案
- 重要操作记录审计日志

## 扩展性设计

### 水平扩展支持

- 网关服务：无状态设计
- 验证服务：基于Token的无状态认证，支持集群部署
- 调度服务：分布式协调，支持多实例协同工作
- 消息集群：分片设计，支持动态添加节点

### 垂直扩展能力

- 各服务独立部署，可根据业务需求单独扩容
- 资源隔离，避免单点瓶颈影响整体系统

## 监控与运维

### 系统监控点

- 网关服务：请求量、响应时间、错误率
- 验证服务：认证成功率、并发连接数
- 调度服务：集群负载、节点健康状态
- 消息集群：连接数、消息吞吐量、资源使用率

## 安全考虑

### 通信安全

- 客户端到网关：HTTPS加密传输
- 服务间通信：gRPC TLS加密
- 敏感数据：端到端加密保护

### 访问控制

- 统一身份认证机制
- 基于角色的权限管理
- API访问频率限制

------

*注：各服务的具体技术实现细节请参考对应的详细文档：*

- `Gateway_server/README.md` - 路由网关服务技术文档
- `Varify_Server/README.md` - 验证服务技术文档
- `scheduler/README.md` - 调度服务技术文档（待实现）
- `message-cluster/README.md` - 消息集群技术文档（待实现）